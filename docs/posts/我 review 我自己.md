---
draft: false 
date: 2024-03-31 
categories:
  - Python
comments: true
authors: [Blake]
---


#  æˆ‘ Review æˆ‘è‡ªå·±
ä»¥ä¸‹å†…å®¹æºäºæˆ‘åœ¨å…¬å¸çš„å†…éƒ¨åˆ†äº«ï¼Œå·²åšè„±æ•å¤„ç†ã€‚

## å¼•å…¥

æˆ‘ä»¬ä¹‹å‰è¯´è¿‡æˆ‘ä»¬æ¯ä¸ªæœˆéƒ½ä¼šæœ‰ä¸€ä¸ª code review çš„ç¯èŠ‚ï¼Œå‡†ç¡®æ¥è¯´è¿™ä¸ç®—æ˜¯ä¸€ä¸ªä»£ç  reviewï¼Œæˆ‘æ€»ç»“äº†ä¸€äº›æˆ‘å†™ä»£ç è¸©è¿‡çš„ä¸€äº›å‘ï¼Œæ‹å‡ºæ¥è·Ÿå¤§å®¶ä¸€èµ·è®¨è®ºä¸€ä¸‹ã€‚
<!-- more -->

## å†…å®¹ä»‹ç»

ä»Šå¤©è®²å››ä¸ªå°ç‚¹çš„å†…å®¹ï¼Œé­”æ³•æ–¹æ³•ï¼Œå¼‚å¸¸å¤„ç†ï¼Œç§»é™¤ä»£ç å’Œåå°„ã€‚

## é­”æ³•æ–¹æ³•

é­”æ³•æ–¹æ³•ï¼Œå®˜æ–¹å«ç‰¹æ®Šæ–¹æ³•ï¼ˆspecial methodsï¼‰ï¼Œä»¥åŒä¸‹åˆ’çº¿å¼€å¤´åŒä¸‹çº¿ç»“å°¾çš„æ–¹æ³•ï¼Œå¸¸è§çš„æœ‰ `__init__`ã€`__new__` ç­‰ã€‚

å¯¹äº Python å†…ç½®çš„ä¸€äº›å®¹å™¨ç±»å‹ï¼Œå­—å…¸ï¼Œåˆ—è¡¨ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ `len` æ–¹æ³•æ¥è·å–å®ƒçš„é•¿åº¦ï¼Œå°±æ˜¯å…ƒç´ ä¸ªæ•°ã€‚é‚£å¦‚æœæˆ‘ä»¬è‡ªå·±å®ç°äº†ä¸€ä¸ªå®¹å™¨ç±»å‹ ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³è®©å®ƒæ”¯æŒé€šè¿‡ `len` æ–¹æ³•æ¥è·å–å®ƒçš„é•¿åº¦ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåšå‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆå€ŸåŠ© `list` æ¥å®ç°ä¸€ä¸ªé˜Ÿåˆ—ã€‚

```python
 class Full(Exception):
    pass


class Empty(Exception):
    pass


class Queue:

    def __init(self, maxsize):
        self.maxsize = maxsize
        self._data = list()


def push(self, item):
    if len(self._data) == self.maxsize:
        raise Full
    self._data.append(item)


def get(self):
    if not self._data:
        raise Empty
    return self._data.pop(0)
```

æµ‹è¯•æˆ‘ä»¬å®ç°çš„è¿™ä¸ªé˜Ÿåˆ—èƒ½ä¸èƒ½å·¥ä½œã€‚

```shell
>>> q = Queue(10)
>>> q.push(1)
>>> q.push(2)
>>> q.get()
1
>>> q.get()
2
>>> q.get()
Traceback (most recent call last):
...
__main__.Empty
```

å›åˆ°æˆ‘ä»¬åˆšåˆšé‚£ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬ä¹Ÿæƒ³è®©å®ƒæ”¯æŒé€šè¿‡ `len` Â æ–¹æ³•æ¥è·å–å®ƒçš„é•¿åº¦ï¼Œæˆ‘ä»¬è¦æ€ä¹ˆåšå‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¸€ä¸ªÂ `__len__`Â é­”æ³•æ–¹æ³•æ¥å®ç°åœ¨è¿™æ ·çš„åŠŸèƒ½ã€‚

```python
def __len__(self):
  return len(self._data)
```

```shell
>>> q = Queue(10)  
>>> q.push(1)
>>> q.push(2)
>>> len(q)
2
```

åˆšåˆšæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œä»‹ç»äº†è¿™ä¸ªÂ `__len__` é­”æ³•æ–¹æ³•çš„ä¸€ä¸ªåŠŸèƒ½ã€‚å½“ç„¶ä»Šå¤©çš„é‡ç‚¹ä¸æ˜¯æ•™å¤§å®¶è¿™äº›é­”æ³•æ–¹æ³•æ€ä¹ˆä½¿ç”¨ï¼Œæˆ‘çŸ¥é“å·²ç»æœ‰ä¸€äº›åŒå­¦å¯¹é­”æ³•æ–¹æ³•å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»Šå¤©æƒ³è¯´çš„æ˜¯é­”æ³•æ–¹æ³•ä½¿ç”¨çš„æ³¨æ„äº‹é¡¹ã€‚

æˆ‘ä»¬çœ‹ä¸‹ *Fluent Python* ä¸­å¯¹é­”æ³•æ–¹æ³•çš„ä¸€ä¸ªè®²è¿°ã€‚å®ƒæ˜¯è¿™æ ·è¯´çš„ã€‚

> å…³äºé­”æ³•æ–¹æ³•ï¼Œä½ é¦–å…ˆè¦çŸ¥é“çš„æ˜¯å®ƒä»¬æ˜¯ç”± Python è§£é‡Šå™¨è°ƒç”¨çš„ï¼Œè€Œä¸æ˜¯ä½ è‡ªå·±æ¥è°ƒç”¨çš„ã€‚

æ€ä¹ˆç†è§£è¿™å¥è¯å‘¢ï¼Ÿæˆ‘ä»¬å†å›åˆ°æˆ‘èƒ½åˆšåˆšçš„ä¾‹å­é‡Œé¢ã€‚

ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å®šä¹‰çš„é­”æ³•æ–¹æ³•ï¼Œæ˜¯è®©å®ƒæ”¯æŒ Python çš„ä¸€äº›è¯­æ³•æœºåˆ¶ï¼Œæˆ‘ä»¬ç»™è‡ªå®šä¹‰çš„ç±»å‹å®šä¹‰äº† `__len__` æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†è®©å®ƒæ”¯æŒé€šè¿‡ `len` æ–¹æ³•è·å–é•¿åº¦ï¼Œè€Œä¸æ˜¯è¯´æˆ‘ä»¬è¦è‡ªå·±è°ƒç”¨ `__len__` æ–¹æ³•ã€‚

è¿™æ—¶å€™ï¼Œå¯èƒ½æœ‰çš„åŒå­¦ä¼šé—®ï¼Œç›´æ¥è°ƒç”¨è°ƒç”¨é­”æ³•æ–¹æ³•æ˜¯ä¸æ˜¯æ›´å¿«ï¼Ÿæé—®ç¯èŠ‚ğŸ™‹â€

é‚£æˆ‘ä»¬ç›´æ¥ä»£ç å®éªŒä¸€ä¸‹ã€‚

```python
q = Queue(1000)
start = time.perf_counter()
for _ in range(10000):
    len(q)
end = time.perf_counter()
print(f"len: {end - start}")  

start = time.perf_counter()
for _ in range(10000):
    q.__len__()
end = time.perf_counter()
print(f"__len__: {end - start}")
```

è¿è¡Œç»“æœå¦‚ä¸‹ ğŸ‘‡

```
len: 0.002637699999999993
__len__: 0.0023554999999999965
```

å¯ä»¥çœ‹åˆ°ç›´æ¥è°ƒç”¨é­”æ³•æ–¹æ³•çš„ç¡®æ›´å¿«ï¼Œä½†**æ€§èƒ½ä¼˜åŒ–ç¬¬ä¸€éƒ¨å…ˆæ˜¯æ‰¾åˆ°ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆï¼Œå†é’ˆå¯¹æ€§èƒ½ç“¶é¢ˆè¿›è¡Œä¼˜åŒ–**ã€‚æ‰€ä»¥ï¼Œè¿™é‡ŒçœŸçš„æ˜¯ä½ ç¨‹åºçš„æ€§èƒ½ç“¶é¢ˆå—ğŸ¤”ï¼Ÿ

## å¼‚å¸¸å¤„ç†

ç‰¹åˆ«æ˜¯å¯¹äºæˆ‘ä»¬Â ***Â ç¨‹åºï¼Œå¼‚å¸¸å¤„ç†åº”è¯¥æ˜¯æˆ‘ä»¬åœ¨ç¼–ç è¿‡ç¨‹ä¸­é«˜é¢‘é‡åˆ°çš„ä¸€ä¸ªåœºæ™¯ã€‚å¿½ç•¥å¼‚å¸¸ï¼Œç„¶åè¿›è¡Œé‡è¯•ï¼Œæˆ‘ç›¸ä¿¡å„ä½å¼€å‘åŒå­¦æœ€ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚

```python
try:
    ...
except:  # bad
    pass


try:
    ...
except Exception:  # bad
    pass

```

ä¸Šé¢çš„è¿™ç§ä»£ç å‡ºç°åœ¨æˆ‘ä¹‹å‰å†™çš„çš„ä»£ç ä¸­ã€‚æˆ‘ä»¬çœ‹ä¸‹Â PythonÂ ä¹‹ç¦…ä¸­å¯¹å¼‚å¸¸å¤„ç†æ˜¯æ€ä¹ˆæè¿°çš„ã€‚

> ErrorsÂ shouldÂ neverÂ passÂ silently.



æ‰€ä»¥æˆ‘ä»¬çš„ç»“è®ºå°±æ˜¯ï¼šä¸è¦å¿½ç•¥å¼‚å¸¸ï¼è‡³å°‘ï¼Œè®°å½•ä¸‹æ—¥å¿—ã€‚

```python
try:
  ...
except Exception as e:  # at very least, log it
  logger.error(e)
```

## ç§»é™¤ä»£ç 

è¿™æ®µä»£ç å·²ç»åºŸå¼ƒäº†ï¼Œæ˜¯æ³¨é‡Šè¿˜æ˜¯åˆ é™¤ï¼Ÿæé—®ç¯èŠ‚ğŸ™‹â€

*Refactoring* ï¼ˆé‡æ„ï¼‰ä¸­æœ‰ä¸€ä¸ªå°èŠ‚ä¸“é—¨æåˆ°äº†å¯¹äºæ— ç”¨ä»£ç ï¼ˆdeadÂ codeï¼‰è¯¥å¦‚æœå¤„ç†ï¼Œæˆ‘ä»¬çœ‹ä¸‹å®ƒçš„è§‚ç‚¹ã€‚

> ä¸€æ—¦ä»£ç ä¸å†è¢«ä½¿ç”¨ï¼Œæˆ‘ä»¬å°±è¯¥ç«‹é©¬åˆ é™¤å®ƒã€‚æœ‰å¯èƒ½ä»¥ååˆä¼šéœ€è¦è¿™æ®µä»£ç ï¼Œä½†æˆ‘ä»ä¸æ‹…å¿ƒè¿™ç§æƒ…å†µï¼›å°±ç®—çœŸçš„å‘ç”Ÿï¼Œæˆ‘ä¹Ÿå¯ä»¥ä»ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿé‡Œå†æ¬¡å°†å®ƒç¿»æ‰¾å‡ºæ¥ã€‚

å¯èƒ½ä¼šæœ‰åŒå­¦ä¼šé—®ï¼Œä¸‡ä¸€è¿™æ®µä»£ç æˆ‘åé¢è¿˜ä¼šç”¨æ€ä¹ˆåŠï¼Ÿ

ä¼šä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿç¡®å®ä¼šï¼Œä½†æ˜¯éå¸¸å°‘ã€‚è‡³å°‘åœ¨æˆ‘çš„å·¥ä½œç»å†ä¸­ï¼Œä»£ç è¢«åˆ äº†ï¼Œåé¢åˆç”¨åˆ°çš„è¿™ç§æƒ…å†µåŸºæœ¬æ²¡æœ‰ã€‚æ‰€ä»¥ä½ ä¸å¿…ä¸ºäº†è¿™ç§æå°‘å‘ç”Ÿçš„æƒ…å†µï¼ŒæŠŠä¸ç”¨çš„ä»£ç ç•™ä¸‹æ¥ï¼Œä½ æŠŠæ— ç”¨çš„ä»£ç ç•™ä¸‹æ¥æ˜¯æœ‰æˆæœ¬çš„ã€‚æ›´ä½•å†µï¼Œæˆ‘ä»¬æœ‰ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼Œç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿçš„å­˜åœ¨ï¼Œå°±æ˜¯æ¥è®°å½•çš„ä»£ç çš„æ”¹åŠ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™ä¸ªå·¥ä½œäº¤ç»™å®ƒåšäº†å°±è¡Œäº†ï¼Œä½ åˆ äº†ï¼Œè¿˜èƒ½é€šè¿‡ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿæ‰¾å›æ¥ã€‚

æ‰€ä»¥ç»“è®ºæ˜¯ä¸ç”¨ä»£ç çš„ç›´æ¥åˆ ï¼Œä¸è¦æœ‰ä¸æ¯«çŠ¹è±«ï¼Œæ”¾å¿ƒåˆ ï¼Œå¤§èƒ†åˆ ï¼Œé—ç•™çš„æ— ç”¨ä»£ç ï¼ˆå³ä½¿è¢«æ³¨é‡Šæ‰ï¼‰åªä¼šç™½ç™½å¢åŠ ä½ ä»£ç çš„å¤æ‚åº¦ï¼Œå¢åŠ é˜…è¯»è€…çš„å¿ƒæ™ºæˆæœ¬ã€‚



## ä½¿ç”¨åå°„

PythonÂ ä¸­æœ‰å¾ˆå¤šæ–¹æ³•åˆ©ç”¨äº†åå°„æœºåˆ¶ï¼Œä¾‹å¦‚ï¼š`type`ï¼Œ`isinstance`ï¼Œ`callable`ï¼Œ`gettarr`Â ç­‰ï¼Œæœ¬ç« èŠ‚çš„è§‚ç‚¹åªé’ˆå¯¹Â `getattr`ï¼Œä»Šå¤©å…ˆåªæ¬ºè´ŸÂ `getattr`Â å®ƒä¸€ä¸ªã€‚

å…ˆç®€å•æ¼”ç¤ºä¸‹Â `getattr`Â çš„ç”¨æ³•ã€‚

```python
class Person:

    def __init__(self, name, gendr):
        self.name = name
        self.gender = gender

    @staticmethod
    def eat(food):
        print(f"eating {food}...")


>>> p = Person("Blake", "male")
>>> getattr(p, "name")
Blake
>>> getattr(p, "eat")(meat)
eating meat...
```

å¥½æˆ‘ä»¬ç°åœ¨å·²ç»çŸ¥é“äº†Â `getattr`Â çš„ç”¨æ³•ï¼Œå½“ç„¶å¦‚ä½•ä½¿ç”¨ä¸æ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹ï¼Œæˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹æ˜¯ä½¿ç”¨æ³¨æ„äº‹é¡¹ã€‚



æˆ‘ä»¬æ¥çœ‹ä¸‹è°·æ­ŒÂ PythonÂ ä»£ç é£æ ¼æŒ‡å—ä¸­ï¼Œå¯¹äºåå°„ç­‰è¿™ä¸€ç±» â€å¥‡æŠ€æ·«å·§â€œ çš„ä½¿ç”¨æé†’ã€‚

> è¿™äº›å¾ˆé…·ï¼ˆåå°„ã€å…ƒç±»ç­‰ï¼‰çš„ç‰¹æ€§ååˆ†è¯±äºº, ä½†å¤šæ•°æƒ…å†µä¸‹æ²¡å¿…è¦ä½¿ç”¨ã€‚åŒ…å«å¥‡æŠ€æ·«å·§çš„ä»£ç éš¾ä»¥é˜…è¯»ã€ç†è§£å’Œè°ƒè¯•ã€‚ ä¸€å¼€å§‹å¯èƒ½è¿˜å¥½(å¯¹åŸä½œè€…è€Œè¨€)ï¼Œä½†ä»¥åå›é¡¾ä»£ç æ—¶ï¼Œè¿™ç§ä»£ç é€šå¸¸æ¯”é‚£äº›é•¿è€Œç›´ç™½çš„ä»£ç æ›´åŠ æ·±å¥¥ã€‚



æˆ‘è‡ªå·±çš„ä¸šåŠ¡ä»£ç ä¹Ÿç”¨åˆ°äº†Â `getattr`ï¼Œç¡®å®ç»™æˆ‘åé¢å¢åŠ äº†ä¸€äº›é˜…è¯»å’Œè°ƒè¯•ä¸Šçš„æˆæœ¬ï¼Œæ‰€ä»¥å¤§å®¶å¯¹ä¸Â `getattr`Â è¿˜æ˜¯è¦ä¿æŒè°¨æ…ã€‚

## å‚è€ƒèµ„æ–™

- [Fluent Python: Clear, Concise, and Effective Programming](https://book.douban.com/subject/27028517/)

- [Refactoring: Improving the Design of Existing Code](https://book.douban.com/subject/30468597/)

- [PEP 20 â€“ The Zen of Python | peps.python.org](https://peps.python.org/pep-0020/)

- [Avoiding Silent Failures in Python: Best Practices for Error Handling](https://pybit.es/articles/python-errors-should-not-pass-silently/)

- [Google Python Style Guide](https://zh-google-styleguide.readthedocs.io/en/latest/google-python-styleguide/contents/)